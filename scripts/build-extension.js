import fs from 'fs-extra'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

async function buildExtension() {
  const distDir = path.join(__dirname, '../dist')
  const publicDir = path.join(__dirname, '../public')
  
  console.log('Building Chrome Extension...')
  
  // ç¡®ä¿distç›®å½•å­˜åœ¨
  await fs.ensureDir(distDir)
  
  // å¤åˆ¶manifest.json
  const manifestSrc = path.join(publicDir, 'manifest.json')
  const manifestDest = path.join(distDir, 'manifest.json')
  await fs.copy(manifestSrc, manifestDest)
  console.log('âœ“ Copied manifest.json')
  
  // å¤åˆ¶å›¾æ ‡æ–‡ä»¶
  const iconsSrc = path.join(publicDir, 'icons')
  const iconsDest = path.join(distDir, 'icons')
  if (await fs.pathExists(iconsSrc)) {
    await fs.copy(iconsSrc, iconsDest, {
      filter: (src, _dest) => {
        // åªå¤åˆ¶ PNG æ–‡ä»¶ï¼Œè·³è¿‡å…¶ä»–æ–‡ä»¶
        if (src.endsWith('.png')) return true
        if (fs.statSync(src).isDirectory()) return true
        return false
      }
    })
    console.log('âœ“ Copied icon PNG files')

    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ‰€éœ€çš„å›¾æ ‡æ–‡ä»¶
    const requiredIcons = ['icon16.png', 'icon32.png', 'icon48.png', 'icon128.png']
    const missingIcons = []

    for (const iconFile of requiredIcons) {
      const iconPath = path.join(iconsDest, iconFile)
      if (!await fs.pathExists(iconPath)) {
        missingIcons.push(iconFile)
      }
    }

    if (missingIcons.length > 0) {
      console.warn(`âš ï¸  Missing icon files: ${missingIcons.join(', ')}`)
      console.warn('   Please convert the SVG icons to PNG using the conversion tool')
    }
  }
  
  // ä½¿ç”¨Viteæž„å»ºçš„src/popup/index.html
  const popupHtmlSrc = path.join(distDir, 'src', 'popup', 'index.html')
  const popupHtmlDest = path.join(distDir, 'popup.html')

  if (await fs.pathExists(popupHtmlSrc)) {
    // è¯»å–HTMLå†…å®¹å¹¶ä¿®å¤è·¯å¾„
    let htmlContent = await fs.readFile(popupHtmlSrc, 'utf8')
    // å°†ç»å¯¹è·¯å¾„è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
    htmlContent = htmlContent.replace(/src="\/([^"]+)"/g, 'src="$1"')
    htmlContent = htmlContent.replace(/href="\/([^"]+)"/g, 'href="$1"')
    // ä¿®å¤ä¸‹åˆ’çº¿å¼€å¤´çš„æ–‡ä»¶åå¼•ç”¨ï¼ˆåŒ…æ‹¬ modulepreload é“¾æŽ¥ï¼‰
    htmlContent = htmlContent.replace(/_plugin-vue_export-helper\.js/g, 'plugin-vue-export-helper.js')
    // å†™å…¥ä¿®å¤åŽçš„å†…å®¹
    await fs.writeFile(popupHtmlDest, htmlContent)
    console.log('âœ“ Moved and fixed popup/index.html to popup.html')
  } else {
    console.error('Error: src/popup/index.html not found in dist directory')
    process.exit(1)
  }

  // ä¿®å¤ä¸‹åˆ’çº¿å¼€å¤´çš„æ–‡ä»¶åï¼ˆChrome æ‰©å±•ä¸å…è®¸ï¼‰
  await fixUnderscoreFiles(distDir)
  
  // content.css å·²ç»ç”± Vite æž„å»ºç”Ÿæˆï¼Œæ— éœ€é¢å¤–å¤åˆ¶
  console.log('âœ“ content.css already generated by Vite')
  
  // æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶å’Œç›®å½•
  const unnecessaryDirs = [
    path.join(distDir, 'src')
  ]

  for (const dir of unnecessaryDirs) {
    if (await fs.pathExists(dir)) {
      try {
        await fs.remove(dir)
        console.log(`âœ“ Cleaned up ${dir}`)
      } catch (error) {
        console.warn(`Failed to clean up ${dir}:`, error.message)
      }
    }
  }
  
  console.log('\nðŸŽ‰ Extension build completed!')
  console.log('\nGenerated files:')
  console.log('â”œâ”€â”€ manifest.json')
  console.log('â”œâ”€â”€ popup.html')
  console.log('â”œâ”€â”€ popup.js')
  console.log('â”œâ”€â”€ popup.css')
  console.log('â”œâ”€â”€ content.js')
  console.log('â”œâ”€â”€ content.css')
  console.log('â”œâ”€â”€ background.js')
  console.log('â””â”€â”€ icons/')
  console.log('    â”œâ”€â”€ icon16.png')
  console.log('    â”œâ”€â”€ icon32.png')
  console.log('    â”œâ”€â”€ icon48.png')
  console.log('    â””â”€â”€ icon128.png')
  console.log('\nðŸ“¦ Ready to load in Chrome Extensions!')
  console.log('1. Open chrome://extensions/')
  console.log('2. Enable "Developer mode"')
  console.log('3. Click "Load unpacked"')
  console.log('4. Select the "dist" folder')
}

// ä¿®å¤ä¸‹åˆ’çº¿å¼€å¤´çš„æ–‡ä»¶å
async function fixUnderscoreFiles(distDir) {
  const files = await fs.readdir(distDir)
  const underscoreFiles = files.filter(file => file.startsWith('_') && file.endsWith('.js'))

  if (underscoreFiles.length === 0) {
    console.log('âœ“ No underscore files to fix')
    return
  }

  for (const file of underscoreFiles) {
    const oldPath = path.join(distDir, file)
    const newName = file.substring(1) // ç§»é™¤å¼€å¤´çš„ä¸‹åˆ’çº¿
    const newPath = path.join(distDir, newName)

    await fs.move(oldPath, newPath, { overwrite: true })
    console.log(`âœ“ Renamed ${file} to ${newName}`)

    // æ›´æ–°æ‰€æœ‰æ–‡ä»¶ä¸­çš„å¼•ç”¨
    await updateFileReferences(distDir, file, newName)
  }
}

// æ›´æ–°æ–‡ä»¶å¼•ç”¨
async function updateFileReferences(distDir, oldName, newName) {
  const filesToUpdate = ['popup.html', 'popup.js', 'content.js', 'background.js']

  for (const fileName of filesToUpdate) {
    const filePath = path.join(distDir, fileName)
    if (await fs.pathExists(filePath)) {
      let content = await fs.readFile(filePath, 'utf8')
      const updated = content.replace(new RegExp(oldName, 'g'), newName)

      if (content !== updated) {
        await fs.writeFile(filePath, updated)
        console.log(`  âœ“ Updated references in ${fileName}`)
      }
    }
  }
}

buildExtension().catch(console.error)
